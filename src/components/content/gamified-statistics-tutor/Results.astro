---
import IframeLearningObject from '@components/IframeLearningObject.astro';
import { learningObjects } from '@/data/learningObjects';

const defaultOpenId = learningObjects.find(lo => lo.defaultOpen)?.id ?? null;
---

<section class="project-results py-12 lg:pb-18 px-4 shadow-sm bg-neutral-200">
    <div class="max-w-screen-xl mx-auto">
    <h3 class="pb-12 text-4xl tracking-tight font-extrabold text-neutral-900 text-center lg:text-left">
        Try it Yourself
    </h3>
  {learningObjects.length === 0 ? (
    <p>No learning objects are configured. Add items to <code>src/data/learningObjects.ts</code>.</p>
  ) : (
    <ul class="lo-list">
      {learningObjects.map((lo) => (
        <li class="p-8 shadow-sm bg-neutral-100 rounded-lg" id={`lo-${lo.id}`}>
          <div class={`lo-row ${lo.thumbnail ? "" : "no-thumb"}`}>
            {lo.thumbnail && (
              <div class="lo-thumb">
                <!-- Clickable thumbnail: toggles preview -->
                <button
                  class="lo-thumb__btn"
                  data-lo-toggle
                  data-target={`#embed-${lo.id}`}
                  aria-controls={`embed-${lo.id}`}
                  aria-expanded={defaultOpenId === lo.id ? "true" : "false"}
                >
                  <img
                    src={lo.thumbnail}
                    alt={lo.thumbnailAlt ?? `${lo.title} thumbnail`}
                    loading="lazy"
                    decoding="async"
                    width="240"
                    height="135"
                  />
                </button>
              </div>
            )}

            <div class="lo-meta">
              <h3 class="text-2xl tracking-tight font-extrabold pb-2 text-primary-500">{lo.title}</h3>
              <button
                class="my-4 bg-background/100 shadow-md px-4 py-2 rounded-lg transition text-neutral-700 border-b-2 border-neutral-300 hover:text-primary-600 hover:border-primary-600 hover:shadow-md hover:shadow-primary-300 inline-flex items-center gap-2"
                data-lo-toggle
                data-target={`#embed-${lo.id}`}
                aria-controls={`embed-${lo.id}`}
                aria-expanded={defaultOpenId === lo.id ? "true" : "false"}
              >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                >

                            <path
                                d="M8.6 5.2A1 1 0 0 0 7 6v12a1 1 0 0 0 1.6.8l8-6a1 1 0 0 0 0-1.6l-8-6Z" clip-rule="evenodd"
                            ></path>
                        </svg>
                <span class="btn-label">{defaultOpenId === lo.id ? "Hide" : "Start"}</span>
              </button>
              {lo.description && <p class="text-base italic font-semibold mb-4">{lo.description}</p>}
            </div>

            <div class="lo-actions">

                <a
                    href={`${lo.path}${lo.path.includes("?") ? "&" : "?"}StandAlone=true`}
                        class="bg-background/100 shadow-md px-4 py-2 rounded-lg transition text-neutral-700 border-b-2 border-neutral-300 hover:text-primary-600 hover:border-primary-600 hover:shadow-md hover:shadow-primary-300 inline-flex items-center gap-2"
                    >
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            viewBox="0 0 24 24"
                        >

                            <path
                                d="M3 11.5h13m-13 0V18a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-6.5m-13 0V9a1 1 0 0 1 1-1h11a1 1 0 0 1 1 1v2.5M9 5h11a1 1 0 0 1 1 1v9a1 1 0 0 1-1 1h-1"                            
                            ></path>
                        </svg>
                        Open in new tab
                    </a>
            </div>
          </div>

          <div
            id={`embed-${lo.id}`}
            class={`lo-embed ${defaultOpenId === lo.id ? "is-open" : ""}`}
            hidden={defaultOpenId === lo.id ? undefined : true}
          >
            <IframeLearningObject
              src={lo.path}
              title={`${lo.title} demo`}
              height="72vh"
              standalone={true}
            />
            <div class="lo-hide">
              <button
                class="link-like"
                data-lo-toggle
                data-target={`#embed-${lo.id}`}
                aria-controls={`embed-${lo.id}`}
                aria-expanded="true"
              >
                Hide preview
              </button>
            </div>
          </div>
        </li>
      ))}
    </ul>
  )}
</section>

<script>
  document.addEventListener("click", (e) => {
    const btn = e.target.closest?.("[data-lo-toggle]");
    if (!btn) return;
    e.preventDefault();

    const targetSel = btn.getAttribute("data-target");
    if (!targetSel) return;

    const panel = document.querySelector(targetSel);
    if (!panel) return;

    // helper: update all buttons that control this panel
    const setControlsFor = (targetSelector, isOpen) => {
      document.querySelectorAll(`[data-lo-toggle][data-target="${targetSelector}"]`).forEach((ctrl) => {
        ctrl.setAttribute("aria-expanded", isOpen ? "true" : "false");
        const label = ctrl.querySelector(".btn-label");
        if (label) label.textContent = isOpen ? "Hide" : "Start";
      });
    };

    const willOpen = panel.hasAttribute("hidden");

    // Close any other open embeds
    document.querySelectorAll(".lo-embed.is-open").forEach((open) => {
      if (open !== panel) {
        open.setAttribute("hidden", "true");
        open.classList.remove("is-open");
        const ctrl = document.querySelector(`[data-lo-toggle][data-target="#${open.id}"]`);
        if (ctrl) {
          ctrl.setAttribute("aria-expanded", "false");
          const lbl = ctrl.querySelector(".btn-label");
          if (lbl) lbl.textContent = "Start";
        }
      }
    });

    if (willOpen) {
      panel.removeAttribute("hidden");
      panel.classList.add("is-open");
      btn.setAttribute("aria-expanded", "true");
      setControlsFor(targetSel, true);
      panel.scrollIntoView({ behavior: "smooth", block: "start" });
      panel.querySelector("iframe")?.focus?.();
    } else {
      panel.setAttribute("hidden", "true");
      panel.classList.remove("is-open");
      btn.setAttribute("aria-expanded", "false");
      setControlsFor(targetSel, false);
    }
  });
</script>

<style>

  .lo-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 1rem; }
  .lo-item { border: 1px solid hsl(0 0% 90%); border-radius: .75rem; padding: 1rem; }

  /* Grid with optional thumbnail column */
  .lo-row {
    display: grid;
    grid-template-columns: 260px 1fr auto;
    gap: 1rem;
    align-items: start;
  }
  .lo-row.no-thumb {
    grid-template-columns: 1fr auto;
  }

  .lo-thumb { width: 100%; max-width: 260px; }
  .lo-thumb__btn {
    display:block; width:100%; background:none; border:none; padding:0; cursor:pointer;
    border-radius:.25rem; overflow:hidden;
  }
  .lo-thumb img {
    width: 100%;
    height: 100%;
  aspect-ratio: 4 / 3;       /* changed from 16 / 9 */
    object-fit: cover;
    display: block;
  }

  .lo-meta { min-width: 0; }
  .lo-name { margin: 0; font-size: 1.05rem; }
  .lo-desc { margin: .35rem 0 0; color: hsl(0 0% 35%); font-size: .95rem; }

  .lo-actions { display: flex; gap: .5rem; flex-wrap: wrap; }

  .btn {
    appearance: none; border: 1px solid hsl(0 0% 80%);
    padding: .5rem .75rem; border-radius: .5rem; background: hsl(0 0% 98%);
    text-decoration: none; font-size: .9rem; line-height: 1;
  }
  .btn:hover { background: hsl(0 0% 94%); }
  .btn-secondary { background: hsl(0 0% 99%); }

  .lo-embed { margin-top: .75rem; }
  .lo-hide { margin-top: .5rem; }
  .link-like { background: none; border: none; padding: 0; text-decoration: underline; cursor: pointer; font-size: .9rem; }
</style>