---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import Layout from '@layouts/Layout.astro';
import Tag from '@components/Tag.astro';
import RelatedPosts from '@components/writing/RelatedPosts.astro';
import ExternalLink from '@components/ExternalLink.astro';
import { formatDate, getReadingTime, getRelatedPosts } from '@utilities/writing';

export const getStaticPaths: GetStaticPaths = async () => {
  const posts = await getCollection('writing');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
};

const { post } = Astro.props;
const { Content } = await post.render();
const { title, description, publishDate, type, tags, externalLinks } = post.data;

// Get related posts
const relatedPosts = await getRelatedPosts(post);

// Reading time
const readingTime = getReadingTime(post.body);

// Type-specific styling
const typeStyles = {
  essay: 'border-primary-600 dark:border-primary-400 bg-primary-50 dark:bg-primary-900/20',
  note: 'border-gray-400 dark:border-gray-500 bg-gray-50 dark:bg-gray-800/50'
};
const typeLabels = {
  essay: 'Essay',
  note: 'Note'
};
---

<Layout title={`${title} | Amos Glenn`} description={description}>
  <main class="container mx-auto px-4 py-12 max-w-4xl">
    <!-- Back Link -->
    <a
      href="/writing"
      class="inline-flex items-center text-primary-600 dark:text-primary-400 hover:underline mb-8"
    >
      <svg
        class="w-5 h-5 mr-2"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 19l-7-7 7-7"
        />
      </svg>
      Back to Writing
    </a>

    <!-- Article Header -->
    <article>
      <header class={`mb-8 pb-8 border-b-4 ${typeStyles[type]} rounded-lg p-6`}>
        <!-- Type and Metadata -->        <div class="flex flex-wrap items-center gap-3 mb-4 text-sm">
          <span
            class={`inline-flex items-center rounded-full px-3 py-1 font-medium
              ${type === 'essay'
                ? 'bg-primary-600 text-white dark:bg-primary-500'
                : 'bg-gray-600 text-white dark:bg-gray-500'
              }`}
          >
            {typeLabels[type]}
          </span>
          <time
            datetime={publishDate.toISOString()}
            class="text-gray-700 dark:text-gray-300"
          >
            {formatDate(publishDate)}
          </time>
          <span class="text-gray-600 dark:text-gray-400">
            {readingTime} min read
          </span>
        </div>

        <!-- Title -->
        <h1 class="text-4xl md:text-5xl font-bold mb-4 text-gray-900 dark:text-gray-100 leading-tight">
          {title}
        </h1>

        <!-- Description -->
        <p class="text-xl text-gray-700 dark:text-gray-300 leading-relaxed">
          {description}
        </p>

        <!-- Tags -->        {tags.length > 0 && (
          <div class="flex flex-wrap gap-2 mt-6">
            {tags.map((tag) => (
              <Tag label={tag} href={`/writing/tags/${tag}`} />
            ))}
          </div>
        )}

        <!-- External Links -->
        {externalLinks && externalLinks.length > 0 && (
          <div class="mt-6 pt-6 border-t border-gray-300 dark:border-gray-600">
            <h2 class="text-sm font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-400 mb-3">
              Referenced
            </h2>
            <ul class="space-y-2">
              {externalLinks.map((link) => (
                <li>
                  <ExternalLink href={link.url} label={link.label} />
                </li>
              ))}
            </ul>
          </div>
        )}
      </header>

      <!-- Content -->
      <div class="prose prose-lg dark:prose-invert max-w-none
        prose-headings:font-bold prose-headings:text-gray-900 dark:prose-headings:text-gray-100
        prose-p:text-gray-800 dark:prose-p:text-gray-200
        prose-a:text-primary-600 dark:prose-a:text-primary-400
        prose-strong:text-gray-900 dark:prose-strong:text-gray-100
        prose-code:text-primary-600 dark:prose-code:text-primary-400
        prose-pre:bg-gray-900 dark:prose-pre:bg-gray-800">
        <Content />
      </div>
    </article>

    <!-- Related Posts -->
    <RelatedPosts posts={relatedPosts} />
  </main>
</Layout>
